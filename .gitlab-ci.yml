stages:
  - getcodemd
  - build

variables:
  ADA_PROJECT_PATH: $CI_PROJECT_DIR/adalib
  EXAMPLES_PATH: $CI_PROJECT_DIR/examples
  ARTIFACTS_PATH: $ADA_PROJECT_PATH/bin
  ALIRE_PATH: $CI_PROJECT_DIR/alire
  GIT_SUBMODULE_STRATEGY: recursive


before_script:
  - apt-get update -qy
  - apt-get install -y gnat
  - apt-get install -y gprbuild
  - git clone --recurse-submodules https://github.com/alire-project/alire.git
  - cd alire
  - dev/build.sh
  - cd ..

build:
  stage: build
  script:
    - cd $ADA_PROJECT_PATH/
    - $ALIRE_PATH/bin/alr -n build
    - export PATH=$PATH:$ALIRE_PATH/bin
    - cd $EXAMPLES_PATH/print
    - alr -n build
    - cd $EXAMPLES_PATH
    - source build.sh

getcodemd:
  stage: prepare
  image: curlimages/curl:8.5.0
  script:
    - >
      curl --header "PRIVATE-TOKEN: $GETARTIFACTS" \
           --location \
           "https://gitlab.com/api/v4/projects/ada23%2Fcodemd/jobs/artifacts/main/download?job=build" \
           --output other.zip
    - unzip other.zip

  artifacts:
    paths:
      - $EXAMPLES_PATH/bin/*

